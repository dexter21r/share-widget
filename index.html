<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Share Widget</title>
    <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css?family=Bitter|Bree+Serif|Caveat|Coiny|Dancing+Script|Indie+Flower|Josefin+Sans|Josefin+Slab|Lato|Libre+Baskerville|Lobster|Lobster+Two|Lora|Monoton|Montserrat|Open+Sans|Oxygen|Poiret+One|Raleway|Righteous|Varela+Round"
        rel="stylesheet">
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.3.1/css/all.css" integrity="sha384-mzrmE5qonljUremFsqc01SB46JvROS7bZs3IO2EmfFsd15uHvIt+Y8vEf7N7fWAU"
        crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.css">
    <link rel="stylesheet" href="color-picker/palette-color-picker.css">
    <style>
        .canvas-container {
            margin: auto;
        }

        #tb-share-dialog {
            border: 1px solid rgb(15, 15, 15);
            overflow: hidden;
            width: 900px;
            /* height: 680px; */
            margin: auto;
        }

        .tb-share-platform-icon {
            border: 1px solid green;
            width: 100px;
            height: 100px;
            overflow: hidden;
            display: inline-block;
            cursor: pointer;
        }

        .tb-share-dialog-close {
            float: right;
        }

        .tb-share-control {
            padding: 2px 5px;
            border: 1px solid #929292;
            border-radius: 3px;
            cursor: pointer;
        }

        .tb-share-dialog-back {
            cursor: pointer;
        }

        #tb-share-canvas {
            margin: auto;
            border: 1px solid violet;
        }

        .tb-share-canvas-container {
            border: 2px solid yellow;
            overflow: auto;
            margin: auto;
        }

        .tb-share-control-container {
            border: 1px solid yellow;
        }

        .tb-share-dialog-box {
            /* border: 2px solid red; */
        }

        .tb-card-header {
            overflow: hidden;
            border: 1px solid red;
        }

        .tb-card-content {
            text-align: center;
            padding: 10px;
            border: 1px solid blue;
        }

        .tb-card-footer {
            overflow: hidden;
            border: 1px solid red;
            text-align: center;
        }

        .tb-canvas-scroll {
            overflow: auto;
            border: 2px solid purple;
        }

        #tb-bg-search-results {
            overflow: auto;
            white-space: nowrap;
        }

        .tb-search-items {
            border: 1px solid #e2e2e2;
            display: inline-block;
            cursor: pointer;
            position: relative;
            margin: 5px;
        }

        .tb-search-image-source {
            width: 50px;
        }

        .tb-search-image-source-link {
            position: absolute;
            bottom: 5px;
            left: 5px;
            background-color: rgba(255, 255, 255, 0.5);
            padding: 0px 2px;
        }
    </style>
</head>

<body>

    <span style="cursor:pointer;" class="shareit">
        <i class="fa fa-share-alt" aria-hidden="true">&nbsp;Share</i>
    </span>

    <div class="tb-share-dialog-box" id="tb-share-dialog" style="display:none;">

        <div id="tb-share-platform-card" class="tb-card">
            <div class="tb-card-header">
                <i class="fa fa-times tb-share-dialog-close tb-share-control" aria-hidden="true"></i>
            </div>
            <div class="tb-card-content">
                <div class="tb-share-platform-list">
                    <div class="tb-share-platform-icon" data-platform="ge">General </div>
                    <div class="tb-share-platform-icon" data-platform="fb">FB </div>
                    <div class="tb-share-platform-icon" data-platform="in">Instagram </div>
                    <div class="tb-share-platform-icon" data-platform="tw">Twitter</div>
                    <div class="tb-share-platform-icon" data-platform="pi">Pintrest</div>
                    <div class="tb-share-platform-icon" data-platform="gp">Google Plus</div>
                </div>
            </div>
            <div class="tb-card-footer">Card Footer</div>
        </div>

        <div id="tb-share-canvas-card" style="display:none;">
            <div class="tb-card-header">
                <i class="fa fa-times tb-share-dialog-close tb-share-control" aria-hidden="true"></i>
                <i class="fa fa-arrow-left tb-share-dialog-back tb-share-control" aria-hidden="true"></i>

                <i id="btnZoomIn" class="fas fa-search-plus tb-share-control"></i>
                <i id="btnZoomOut" class="fas fa-search-minus tb-share-control"></i>
                <i id="btnResetZoom" class="tb-share-control">Reset Zoom</i>
                <input type="text" id="color-picker" name="color-picker">
                <span id="tb-share-text-controls" style="display:none;">
                    <select>
                        <option></option>
                    </select>
                </span>
            </div>
            <div class="tb-card-content tb-canvas-scroll" data-simplebar>
                <div class="tb-share-canvas-container">
                    <canvas id="tb-share-canvas"></canvas>
                </div>
            </div>
            <div class="tb-card-footer">
                <div class="tb-share-control-container">
                    <input type="search" id="tb-txtsearch" name="txtsearch" placeholder="Search Background Image..." />
                    <button type="submit" id="tb-btnsearch">Search</button>
                    <div id="tb-bg-search-results">

                    </div>
                </div>
            </div>
        </div>
    </div>

    <div style="font-family: 'Lato', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Open Sans', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Montserrat', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Raleway', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Lora', serif;">&nbsp;</div>
    <div style="font-family: 'Indie Flower', cursive;">&nbsp;</div>
    <div style="font-family: 'Oxygen', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Bitter', serif;">&nbsp;</div>
    <div style="font-family: 'Josefin Sans', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Josefin Slab', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Libre Baskerville', serif;">&nbsp;</div>
    <div style="font-family: 'Lobster', cursive;">&nbsp;</div>
    <div style="font-family: 'Varela Round', sans-serif;">&nbsp;</div>
    <div style="font-family: 'Dancing Script', cursive;">&nbsp;</div>
    <div style="font-family: 'Bree Serif', serif;">&nbsp;</div>
    <div style="font-family: 'Coiny', cursive;">&nbsp;</div>
    <div style="font-family: 'Righteous', cursive;">&nbsp;</div>
    <div style="font-family: 'Poiret One', cursive;">&nbsp;</div>
    <div style="font-family: 'Caveat', cursive;">&nbsp;</div>
    <div style="font-family: 'Monoton', cursive;">&nbsp;</div>
    <div style="font-family: 'Lobster Two', cursive;">&nbsp;</div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.3.6/fabric.min.js" crossorigin="anonymous"></script>
    <script src="centering_guidelines.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/simplebar@latest/dist/simplebar.js"></script>
    <script src="color-picker/palette-color-picker.min.js"></script>
    <script>

        $('#color-picker').paletteColorPicker({
            colors: ['#D50000','#304FFE','#00B8D4','#69F0AE','#FFFF00','#F8BBD0'],
            clear_btn: null
        });


        var canvas;
        var scaleX, scaleY, textArea, textArea2, brand;
        var totalAssets = 3;
        var loadedAssets = 0;
        var canvasScale = 1;
        var SCALE_FACTOR = 1.2;
        var backgroundImage = '';
        var panning = false;
        var orientation = 'horizontal';

        //$('.shareit').click(function () {
        console.log('Share Button Clicked');
        $('#tb-share-dialog').show();
        //});

        $(document).on('click', '.tb-share-dialog-close', function () {
            $('#tb-share-dialog').hide();
        });

        // button Zoom In
        $("#btnZoomIn").click(function () {
            zoomIn();
        });
        // button Zoom Out
        $("#btnZoomOut").click(function () {
            zoomOut();
        });
        // button Reset Zoom
        $("#btnResetZoom").click(function () {
            resetZoom();
        });

        $(document).on('click', '.tb-search-items', function () {
            console.log('image clicked');
            var imageUrl = $(this).data('url');
            $.ajax({
                url: 'tb-share-widget.php',
                type: 'POST',
                data: {
                    action: 'save-image',
                    imageurl: imageUrl
                },
                success: function (res) {
                    console.log(res);
                    fabric.Image.fromURL(res.data, function (img) {
                        backgroundImage = img;
                        canvas.setBackgroundImage(backgroundImage, canvas.renderAll.bind(
                            canvas), {
                            scaleX: canvas.width / backgroundImage.width,
                            scaleY: canvas.height / backgroundImage.height
                        });
                    });

                },
                error: function (error) {
                    console.log(error);
                }
            });
        });

        $(document).on('click', '#tb-btnsearch', function () {
            var searchTerm = $('#tb-txtsearch').val();
            console.log('Search', searchTerm);

            if (searchTerm && searchTerm.length > 3) {
                console.log('Search it');
                $.ajax({
                    url: 'tb-share-widget.php',
                    type: 'POST',
                    data: {
                        action: 'search',
                        searchterm: searchTerm,
                        orientation: orientation
                    },
                    success: function (res) {
                        console.log(res);
                        var images = res.data;
                        var searchHtml = '';
                        images.forEach(function (item) {
                            searchHtml +=
                                '<div class="tb-search-items" data-url="' + item.largeImageURL +
                                '">\n\
                                    <a target="_blank" href="' +
                                item.pageURL +
                                '" class="tb-search-image-source-link">\n\
                                    <img class="tb-search-image-source"  src="pixabay.svg" /></a>\n\
                                    <img class="tb-search-image-preview" src="' +
                                item.previewURL +
                                '" />\n\
                                </div>';
                        })
                        $('#tb-bg-search-results').html(searchHtml);
                    },
                    error: function (error) {
                        console.log(error);
                    }
                });
            }
        });

        $(document).on('click', '.tb-share-platform-icon', function () {
            console.log($(this).data('platform'));
            $('#tb-share-platform-card').hide();
            $('#tb-share-canvas-card').show();

            var width = 1024;
            var height = 1024;
            orientation = 'horizontal';
            var platform = $(this).data('platform');
            switch (platform) {
                case 'fb':
                    width = 940;
                    height = 788;
                    break;
                case 'in':
                    width = 1080;
                    height = 1080;
                    break;
                case 'tw':
                    width = 1024;
                    height = 512;
                    break;
                case 'pi':
                    width = 600;
                    height = 900;
                    orientation = 'vertical';
                    break;
                case 'gp':
                    width = 1024;
                    height = 512;
                    break;
                case 'ge':
                    width = 1024;
                    height = 1024;
                    break;
                default:
                    break;
            }

            totalAssets = 3;
            loadedAssets = 0;

            canvas = new fabric.Canvas('tb-share-canvas', {});

            canvas.setWidth(width);
            canvas.setHeight(height);

            // initCenteringGuidelines(canvas);

            var deviceHeight = 600 * 70 / 100; //480; //;262.5;
            var deviceWidth = width * deviceHeight / height;

            $('.tb-canvas-scroll').height(deviceHeight + 10);
            console.log('Width: ' + deviceWidth);
            console.log('Height: ' + deviceHeight);
            scaleX = (deviceWidth / width);
            scaleY = (deviceHeight / height);
            console.log('Scale Factor: X: ' + scaleX + ' , Y: ' + scaleY);


            fabric.Image.fromURL(
                'http://www.qygjxz.com/data/out/129/4777797-images-wallpaper.jpeg',
                function (img) {
                    backgroundImage = img;
                    console.log('Image width: ' + (width / img.width) + 'Image height: ' + img.height);
                    // var oImg = backgroundImage.set({
                    //     // left: 0,
                    //     // top: 0,
                    //     // angle: 0,
                    //     // width: width,
                    //     // height: height,
                    //     // scaleX: width / img.width, // Mobileview
                    //     // scaleY:  height / img.height// Mobileview
                    // });
                    canvas.setBackgroundImage(backgroundImage, canvas.renderAll.bind(canvas), {
                        scaleX: canvas.width / backgroundImage.width,
                        scaleY: canvas.height / backgroundImage.height
                    });

                    //canvas.backgroundImageStretch = true;
                    //canvas.renderAll();
                    // canvas.backgroundImageStretch = true;
                    console.log('==> backgroud loaded');
                    // var dataURL = canvas.toDataURL({
                    // 	format: 'png',
                    // 	quality: 0.8
                    // });
                    loadedAssets++;
                    checkAssetsLoading();
                });

            // Add Brand Name 
            brand = new fabric.Text('site.com', {
                left: canvas.getWidth() - 160,
                top: 5,
                fontSize: 21,
                fontFamily: 'Josefin Slab',
                textAlign: 'center',
                fontWeight: "bold",
                fill: '#fff',
                borderColor: "#CCC",
                selectable: false,
                stroke: 'rgba(255, 255, 255,0.5)',
                strokeWidth: 0.2,
                // lineHeight: ta.defaultSettings.lineHeight,
                // fontFamily: ta.defaultSettings.fontFamily,
            });

            canvas.add(brand);
            loadedAssets++;
            checkAssetsLoading();
            // ------

            textArea = new fabric.Textbox(
                'To accomplish great things, we must not only act, but also dream; not only plan, but also believe.', {
                    width: canvas.getWidth() - 200,
                    stroke: 'rgba(0,0,0,0.5)',
                    strokeWidth: 0.2,
                    fontSize: 48,
                    fontFamily: 'Lobster Two',
                    textAlign: 'center',
                    // fontWeight: "bold",
                    textDecoration: "normal",
                    fontStyle: "normal",
                    fill: 'yellow',
                    borderColor: "#CCC",
                    editable: false,
                    // lineHeight: ta.defaultSettings.lineHeight,
                    // fontFamily: ta.defaultSettings.fontFamily,
                });
            textArea._forceClearCache = true;

            textArea.set({
                left: (canvas.getWidth() / 2) - (textArea.width / 2),
                top: ((canvas.getHeight() / 2) - (textArea.height / 2)),
                borderDashArray: [2, 2],
                cornerColor: 'white',
                cornerStrokeColor: 'black',
                cornerStyle: 'circle',
                cornerSize: 12,
                padding: 15,
                transparentCorners: false,
                borderScaleFactor: 2
            });

            textArea.on("changed", function (e) {
                //console.log('textchanges',e);
            });

            canvas.add(textArea);
            loadedAssets++;
            checkAssetsLoading();

            textArea2 = new fabric.Textbox('- Author Name', {
                width: 200,
                height: 150,
                stroke: 'rgba(0,0,0,0.5)',
                strokeWidth: 0.2,
                fontSize: 22,
                fontFamily: 'Bitter',
                textAlign: 'center',
                // fontWeight: "bold",
                textDecoration: "normal",
                fontStyle: "normal",
                fill: '#fff',
                borderColor: "#CCC",
                editable: false,
                // lineHeight: ta.defaultSettings.lineHeight,
                // fontFamily: ta.defaultSettings.fontFamily,
            });
            textArea2._forceClearCache = true;

            textArea2.set({
                left: (canvas.getWidth() / 2) - (textArea2.width / 2),
                top: textArea.top + textArea.height + 50,
                borderDashArray: [2, 2],
                cornerColor: 'white',
                cornerStrokeColor: 'black',
                cornerStyle: 'circle',
                cornerSize: 12,
                padding: 15,
                transparentCorners: false,
                borderScaleFactor: 2
            });

            textArea2.on("changed", function (e) {
                //console.log('textchanges',e);
            });

            canvas.add(textArea2);
            loadedAssets++;
            checkAssetsLoading();

            canvas.on("mouse:up", function (e) {
                //console.log(e);
                if (e.target != null) {
                    var type = e.target.get('type');
                    if (type == 'textbox') {
                        console.log('textbox');
                        $('#tb-share-text-controls').show();
                    } else if (type == 'path-group') {

                    } 

                } else {
                    $('#tb-share-text-controls').hide();
                }
            });

        });

        $(document).on('click', '.tb-share-dialog-back', function () {
            $('#tb-share-platform-card').show();
            $('#tb-share-canvas-card').hide();
            canvas.dispose();

        });

        function resizeCanvas() {
            var w = canvas.getWidth() * scaleX;
            var h = canvas.getHeight() * scaleY;
            canvas.setWidth(w);
            canvas.setHeight(h);
            console.log(w + ' ' + h + ' ' + canvas.getWidth() + ' ');
            $('.tb-share-canvas-container').css({
                width: w + 5,
                height: h + 5
            });

            var objects = canvas.getObjects();
            for (var i in objects) {

                console.log('=========change size', objects[i].get('type'));
                var sX = objects[i].scaleX;
                var sY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = sX * scaleX;
                var tempScaleY = sY * scaleY;
                var tempLeft = left * scaleX;
                var tempTop = top * scaleY;

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;

                objects[i].setCoords();
            }

            canvas.renderAll();
        }

        function checkAssetsLoading() {
            if (totalAssets == loadedAssets) {
                resizeCanvas();
            }
        }

        // Zoom In
        function zoomIn() {
            // TODO limit the max canvas zoom in

            canvasScale = canvasScale * SCALE_FACTOR;

            canvas.setHeight(canvas.getHeight() * SCALE_FACTOR);
            canvas.setWidth(canvas.getWidth() * SCALE_FACTOR);

            var objects = canvas.getObjects();
            for (var i in objects) {
                var scaleX = objects[i].scaleX;
                var scaleY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = scaleX * SCALE_FACTOR;
                var tempScaleY = scaleY * SCALE_FACTOR;
                var tempLeft = left * SCALE_FACTOR;
                var tempTop = top * SCALE_FACTOR;

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;

                objects[i].setCoords();
            }

            var oImg = backgroundImage.set({
                scaleX: backgroundImage.scaleX * SCALE_FACTOR,
                scaleY: backgroundImage.scaleY * SCALE_FACTOR
            });
            canvas.setBackgroundImage(oImg);

            $('.tb-share-canvas-container').css({
                width: canvas.getWidth() + 5,
                height: canvas.getHeight() + 5
            });

            canvas.renderAll();
        }

        // Zoom Out
        function zoomOut() {
            // TODO limit max cavas zoom out

            canvasScale = canvasScale / SCALE_FACTOR;

            canvas.setHeight(canvas.getHeight() * (1 / SCALE_FACTOR));
            canvas.setWidth(canvas.getWidth() * (1 / SCALE_FACTOR));

            var objects = canvas.getObjects();
            for (var i in objects) {
                var scaleX = objects[i].scaleX;
                var scaleY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = scaleX * (1 / SCALE_FACTOR);
                var tempScaleY = scaleY * (1 / SCALE_FACTOR);
                var tempLeft = left * (1 / SCALE_FACTOR);
                var tempTop = top * (1 / SCALE_FACTOR);

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;

                objects[i].setCoords();
            }

            var oImg = backgroundImage.set({
                scaleX: backgroundImage.scaleX / SCALE_FACTOR,
                scaleY: backgroundImage.scaleY / SCALE_FACTOR
            });
            canvas.setBackgroundImage(oImg);

            $('.tb-share-canvas-container').css({
                width: canvas.getWidth() + 5,
                height: canvas.getHeight() + 5
            });

            canvas.renderAll();
        }

        // Reset Zoom
        function resetZoom() {

            canvas.setHeight(canvas.getHeight() * (1 / canvasScale));
            canvas.setWidth(canvas.getWidth() * (1 / canvasScale));

            var objects = canvas.getObjects();
            for (var i in objects) {
                var scaleX = objects[i].scaleX;
                var scaleY = objects[i].scaleY;
                var left = objects[i].left;
                var top = objects[i].top;

                var tempScaleX = scaleX * (1 / canvasScale);
                var tempScaleY = scaleY * (1 / canvasScale);
                var tempLeft = left * (1 / canvasScale);
                var tempTop = top * (1 / canvasScale);

                objects[i].scaleX = tempScaleX;
                objects[i].scaleY = tempScaleY;
                objects[i].left = tempLeft;
                objects[i].top = tempTop;

                objects[i].setCoords();
            }

            var oImg = backgroundImage.set({
                scaleX: backgroundImage.scaleX * (1 / canvasScale),
                scaleY: backgroundImage.scaleY * (1 / canvasScale)
            });
            canvas.setBackgroundImage(oImg);

            $('.tb-share-canvas-container').css({
                width: canvas.getWidth() + 5,
                height: canvas.getHeight() + 5
            });

            canvas.renderAll();

            canvasScale = 1;
        }
    </script>
</body>

</html>